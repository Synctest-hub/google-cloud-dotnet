// Copyright 2022 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License").
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

using Google.Cloud.ClientTesting;
using Google.Cloud.Spanner.Data.CommonTesting;
using Google.Cloud.Spanner.V1;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Xunit;

namespace Google.Cloud.Spanner.Data.IntegrationTests;

[Collection(nameof(AllTypesTableFixturePostgreSql))]
[CommonTestDiagnostics]
[Trait(Constants.SupportedOnEmulator, Constants.No)]
public class PgTests
{
    private readonly AllTypesTableFixturePostgreSql _fixture;
    private string _lastKey;

    public PgTests(AllTypesTableFixturePostgreSql fixture) =>
        _fixture = fixture;

    private SpannerConnection GetConnection() => _fixture.GetConnection();

    // Binding tests for PostgreSQL specific types. GSQL and common types are tested in the BindingTests.cs.

    [Fact]
    public async Task BindPgNumeric() =>
        await TestBindNonNull(SpannerDbType.PgNumeric, PgNumeric.Parse("1.0"), r => r.GetPgNumeric(0));

    [Fact]
    public async Task BindPgNumericArray() =>
        await TestBindNonNull(SpannerDbType.ArrayOf(SpannerDbType.PgNumeric), new PgNumeric?[] { PgNumeric.Parse("0.0"), null, PgNumeric.Parse("1.0") });

    [Fact]
    public async Task BindPgNumericEmptyArray() =>
        await TestBindNonNull(SpannerDbType.ArrayOf(SpannerDbType.PgNumeric), new PgNumeric[] { });

    [Fact]
    public async Task BindPgJsonb() =>
        await TestBindNonNull(SpannerDbType.PgJsonb, "{\"key\": \"value\"}", r => r.GetString(0));

    [Fact]
    public async Task BindPgJsonbArray() =>
        await TestBindNonNull(SpannerDbType.ArrayOf(SpannerDbType.PgJsonb), new string[] { "{\"key\": \"value\"}", null, "{\"other-key\": \"other-value\"}" });

    private async Task TestBindNonNull<T>(SpannerDbType parameterType, T value, Func<SpannerDataReader, T> typeSpecificReader = null)
    {
        using var connection = GetConnection();
        using var cmd = connection.CreateSelectCommand("SELECT $1");
        cmd.Parameters.Add("p1", parameterType, value);
        using var reader = await cmd.ExecuteReaderAsync();
        await BindingTests.AssertNotNull<T>(reader, value, typeSpecificReader);
    }

    public static TheoryData<SpannerDbType> BindNullData { get; } = new TheoryData<SpannerDbType>
    {
        SpannerDbType.PgNumeric,
        SpannerDbType.PgJsonb,
        SpannerDbType.ArrayOf(SpannerDbType.PgNumeric),
        SpannerDbType.ArrayOf(SpannerDbType.PgJsonb)
    };

    [Theory]
    [MemberData(nameof(BindNullData))]
    public async Task BindNull(SpannerDbType parameterType)
    {
        using var connection = GetConnection();
        using var cmd = connection.CreateSelectCommand("SELECT $1");
        cmd.Parameters.Add("p1", parameterType, null);
        using var reader = await cmd.ExecuteReaderAsync();
        await BindingTests.AssertNull(reader);
    }

    // Schema Table Tests for PostgreSQL specific types. GSQL and common types are tested in the GetSchemaTableTests.cs

    [MemberData(nameof(SchemaTestData))]
    [Theory]
    public async Task GetSchemaTable_WithFlagEnabled_ReturnsSchema(string columnName, System.Type type, SpannerDbType spannerDbType)
    {
        string selectQuery = $"SELECT \"{columnName}\" FROM {_fixture.TableName}";
        await GetSchemaTableTests.GetSchemaTable_WithFlagEnabled_ReturnsSchema_Impl(columnName, type, spannerDbType, _fixture.ConnectionString, selectQuery);
    }

    public static TheoryData<string, System.Type, SpannerDbType> SchemaTestData { get; } =
        new TheoryData<string, System.Type, SpannerDbType>
        {
            // Base types.
            { "PgNumericValue", typeof(PgNumeric), SpannerDbType.PgNumeric },
            { "PgJsonbValue", typeof(string), SpannerDbType.PgJsonb },
            // Array types.
            { "PgNumericArrayValue", typeof(List<PgNumeric>), SpannerDbType.ArrayOf(SpannerDbType.PgNumeric) },
            { "PgJsonbArrayValue", typeof(List<string>), SpannerDbType.ArrayOf(SpannerDbType.PgJsonb) }
        };

    // Write Tests for PostgreSQL specific types. GSQL and common types are tested in WriteTests.cs

    [Theory]
    [InlineData("{\"key\": \"value\"}")]       // Whitespace between key and value.
    [InlineData("{\"key\":\"value\"}")]        // No whitespace between key and value.
    [InlineData("{\"key\":   \"value\"}")]     // Multiple whitespaces between key and value.
    [InlineData("  {\"key\" :  \"value\"}  ")] // Whitespace before and after key and value.
    public async Task WritePgJsonb_WithWhitespace(string input)
    {
        var parameters = new SpannerParameterCollection
        {
            { "PgJsonbValue", SpannerDbType.PgJsonb, input }
        };

        Assert.Equal(1, await InsertAsync(parameters));

        // Whitespace is not persisted. Key and value is always formatted with just one whitespace between them.
        // Rest of the whitespaces (if any or lack of it) is lost.
        var expectedValue = "{\"key\": \"value\"}";
        await WriteTests.WithLastRowAsync(reader =>
        {
            Assert.Equal(expectedValue, reader.GetFieldValue<string>(reader.GetOrdinal("PgJsonbValue")));
        }, GetConnection(), GetWriteTestReader);
    }

    [Fact]
    public async Task WriteNulls() =>
        await ExecuteWriteNullsTest(InsertAsync);

    [Fact]
    public async Task WriteValues() =>
        await ExecuteWriteValuesTest(InsertAsync);

    [Fact]
    public async Task WriteEmpties()
    {
        var parameters = new SpannerParameterCollection
            {
                { "PgNumericArrayValue", SpannerDbType.ArrayOf(SpannerDbType.PgNumeric), new PgNumeric[0] },
                { "PgJsonbArrayValue", SpannerDbType.ArrayOf(SpannerDbType.PgJsonb), new string[0] }
            };

        Assert.Equal(1, await InsertAsync(parameters));
        await WriteTests.WithLastRowAsync(reader =>
        {
            Assert.Equal(new PgNumeric[] { }, reader.GetFieldValue<PgNumeric[]>(reader.GetOrdinal("PgNumericArrayValue")));
            Assert.Equal(new string[] { }, reader.GetFieldValue<string[]>(reader.GetOrdinal("PgJsonbArrayValue")));
        }, GetConnection(), GetWriteTestReader);
    }

    private async Task ExecuteWriteNullsTest(Func<SpannerParameterCollection, Task<int>> insertCommand)
    {
        var parameters = new SpannerParameterCollection
            {
                { "PgNumericValue", SpannerDbType.PgNumeric, null },
                { "PgJsonbValue", SpannerDbType.PgJsonb, null },
                { "PgNumericArrayValue", SpannerDbType.ArrayOf(SpannerDbType.PgNumeric), null },
                { "PgJsonbArrayValue", SpannerDbType.ArrayOf(SpannerDbType.PgJsonb), null }
            };

        Assert.Equal(1, await insertCommand(parameters));
        await WriteTests.WithLastRowAsync(reader =>
        {
            Assert.True(reader.IsDBNull(reader.GetOrdinal("PgNumericValue")));
            Assert.True(reader.IsDBNull(reader.GetOrdinal("PgJsonbValue")));
            Assert.True(reader.IsDBNull(reader.GetOrdinal("PgNumericArrayValue")));
            Assert.True(reader.IsDBNull(reader.GetOrdinal("PgJsonbArrayValue")));
        }, GetConnection(), GetWriteTestReader);
    }

    private async Task ExecuteWriteValuesTest(Func<SpannerParameterCollection, Task<int>> insertCommand)
    {
        PgNumeric?[] numericArray = { PgNumeric.Parse("0.0"), null, PgNumeric.Parse("2.0") };
        string jsonbValue = "{\"f1\": \"v1\"}";
        string[] jsonbArrayValue = { "{\"f1\": \"v1\"}", "{}", "[]", null };

        var parameters = new SpannerParameterCollection
        {
            { "PgNumericValue", SpannerDbType.PgNumeric, PgNumeric.Parse("2.0") },
            { "PgJsonbValue", SpannerDbType.PgJsonb, jsonbValue },
            { "PgNumericArrayValue", SpannerDbType.ArrayOf(SpannerDbType.PgNumeric), numericArray },
            { "PgJsonbArrayValue", SpannerDbType.ArrayOf(SpannerDbType.PgJsonb), jsonbArrayValue }
        };

        Assert.Equal(1, await insertCommand(parameters));
        await WriteTests.WithLastRowAsync(reader =>
        {
            Assert.Equal(PgNumeric.Parse("2.0"), reader.GetFieldValue<PgNumeric>(reader.GetOrdinal("PgNumericValue")));
            Assert.Equal(jsonbValue, reader.GetFieldValue<string>(reader.GetOrdinal("PgJsonbValue")));
            Assert.Equal(numericArray, reader.GetFieldValue<PgNumeric?[]>(reader.GetOrdinal("PgNumericArrayValue")));
            Assert.Equal(jsonbArrayValue, reader.GetFieldValue<string[]>(reader.GetOrdinal("PgJsonbArrayValue")));
        }, GetConnection(), GetWriteTestReader);
    }

    private async Task<SpannerDataReader> GetWriteTestReader(SpannerConnection connection)
    {
        var command = connection.CreateSelectCommand($"SELECT * FROM {_fixture.TableName} WHERE K=$1");
        command.Parameters.Add("p1", SpannerDbType.String, _lastKey);
        return await command.ExecuteReaderAsync();
    }

    private async Task<int> InsertAsync(SpannerParameterCollection values)
    {
        using var connection = GetConnection();
        values.Add("K", SpannerDbType.String, _lastKey = IdGenerator.FromGuid());
        using var cmd = connection.CreateInsertCommand(_fixture.TableName, values);
        return await cmd.ExecuteNonQueryAsync();
    }
}
